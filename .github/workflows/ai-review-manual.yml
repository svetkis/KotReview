name: AI Review (manual)

on:
  workflow_dispatch:
    inputs:
      review-command:
        type: choice
        default: run
        options: [run, run-inline, run-context, run-summary]
      pull-request-number:
        description: "PR number"
        type: string
        required: true

jobs:
  ai-review:
    # Если у репозитория глобально стоит ограничение прав,
    # явно выдаём права на запись в PR-комменты:
    permissions:
      contents: read
      pull-requests: write

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ВАЖНО: тянем всю историю, чтобы был base_sha

      - uses: Nikita-Filonov/ai-review@v0.39.0
        with:
          review-command: ${{ inputs.review-command }}
        env:
          # Ключ OpenAI из секретов
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          
          LLM__PROVIDER: "OPENROUTER"
          LLM__META__MODEL: "openai/gpt-oss-20b:free"
          LLM__META__MAX_TOKENS: "1500"
          LLM__META__TEMPERATURE: "0.2"
          LLM__HTTP_CLIENT__API_URL: "https://openrouter.ai/api/v1"
          LLM__HTTP_CLIENT__API_TOKEN: ${{ secrets.OPENROUTER_API_KEY }}


          # GitHub-интеграция
          VCS__PROVIDER: "GITHUB"
          VCS__PIPELINE__OWNER: ${{ github.repository_owner }}
          VCS__PIPELINE__REPO: ${{ github.event.repository.name }}
          VCS__PIPELINE__PULL_NUMBER: ${{ inputs.pull-request-number }}
          VCS__HTTP_CLIENT__API_URL: "https://api.github.com"
          VCS__HTTP_CLIENT__API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
